{{- define "main" }}

{{- if (and site.Params.profileMode.enabled .IsHome) }}
  {{- partial "index_profile.html" . }}
{{- else }}

  {{- if not .IsHome | and .Title }}
  <header class="page-header">
    {{- partial "breadcrumbs.html" . }}
    <h1>{{ .Title }}</h1>
  </header>
  {{- end }}

  {{/* --- 筛选栏优化版 --- */}}
  {{- if or (eq .Section "posts") (eq .Kind "term") }}
    {{- $tags := .Site.Taxonomies.tags }}
    {{- if gt (len $tags) 0 }}
    <style>
      .tag-container {
        margin-bottom: 30px;
        padding: 14px;
        border-radius: 12px;
        background: var(--entry) !important; 
        border: 1px solid var(--border);
        /* 预设 contain 属性提高渲染性能 */
        contain: content;
      }
      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-height: 82px; 
        overflow-y: auto;
        padding-bottom: 4px;
        transition: max-height 0.3s ease;
        align-items: center;
        scrollbar-width: thin;
      }
      .tag-list.expanded { max-height: 1000px; overflow-y: visible; }
      .tag-item {
        display: inline-flex;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 13px;
        background: var(--tertiary);
        color: var(--primary);
        text-decoration: none;
        transition: transform 0.1s;
      }
      .tag-item.active {
        background: #007aff !important;
        color: #fff !important;
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.25);
      }
      .dark .tag-item.active { background: #0a84ff !important; }
      .expand-btn {
        margin-top: 8px;
        font-size: 12px;
        color: var(--secondary);
        cursor: pointer;
        text-align: center;
        opacity: 0.6;
      }
    </style>

    <div class="tag-container">
      <div class="tag-list" id="tagList">
        <a href="{{ "/posts" | relLangURL }}" class="tag-item {{ if and (eq .Section "posts") (eq .Kind "section") }}active{{ end }}">全部</a>
        {{- range $tags.ByCount }}
          {{- $is_active := false }}
          {{- if $.Data.Term }}{{ if eq (urlize $.Data.Term) (urlize .Name) }}{{ $is_active = true }}{{ end }}{{ end }}
          <a href="{{ "/tags/" | relLangURL }}{{ .Name | urlize }}" class="tag-item {{ if $is_active }}active{{ end }}">
             {{ .Name }} <span style="font-size: 11px; opacity: 0.6; margin-left: 4px;">{{ .Count }}</span>
          </a>
        {{- end }}
      </div>
      <div class="expand-btn" id="expandBtn" onclick="toggleTags()">展开全部 ↓</div>
    </div>

    <script>
      function toggleTags() {
        const list = document.getElementById('tagList');
        const btn = document.getElementById('expandBtn');
        const isExpanded = list.classList.toggle('expanded');
        btn.innerText = isExpanded ? '收起列表 ↑' : '展开全部 ↓';
      }

      // 改用 DOMContentLoaded，速度提升明显
      document.addEventListener('DOMContentLoaded', () => {
        const list = document.getElementById('tagList');
        const btn = document.getElementById('expandBtn');
        const activeItem = list.querySelector('.active');
        
        // 瞬间检测高度
        if (list.scrollHeight <= 88) {
          btn.style.display = 'none';
        } else if (activeItem && activeItem.offsetTop > 40) {
          list.scrollTop = activeItem.offsetTop - 10;
        }
      });
    </script>
    {{- end }}
  {{- end }}

  {{/* --- 文章列表修复版 --- */}}
  {{- $pages := .RegularPages }}
  {{- if .IsHome }}
    {{- $pages = where site.RegularPages "Type" "in" site.Params.mainSections }}
  {{- end }}
  {{- $pages = where $pages "Params.hiddenInHomeList" "!=" "true"  }}
  
  {{- $paginator := .Paginate $pages }}

  {{- range $paginator.Pages }}
  <article class="post-entry">
    <header class="entry-header">
      <h2 class="entry-hint-parent">{{- .Title }}</h2>
    </header>
    <div class="entry-content">
      <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
    </div>
    <footer class="entry-footer">{{- partial "post_meta.html" . -}}</footer>
    <a class="entry-link" href="{{ .Permalink }}"></a>
  </article>
  {{- end }}

  {{/* 分页逻辑保持不变... */}}
{{- end }}
{{- end }}