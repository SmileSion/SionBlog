{{- define "main" }}

{{- if (and site.Params.profileMode.enabled .IsHome) }}
  {{- partial "index_profile.html" . }}
{{- else }}

  {{- if not .IsHome | and .Title }}
  <header class="page-header">
    {{- partial "breadcrumbs.html" . }}
    <h1>{{ .Title }}</h1>
  </header>
  {{- end }}

  {{/* --- 筛选栏：完美适配黑夜模式 & 严格裁剪 --- */}}
  {{- if or (eq .Section "posts") (eq .Kind "term") }}
    {{- $tags := .Site.Taxonomies.tags }}
    {{- if gt (len $tags) 0 }}
    <style>
      /* 1. 容器：强制同步主题卡片色 */
      .tag-container {
        margin-bottom: 30px;
        padding: 14px 14px 10px 14px;
        border-radius: 12px;
        /* 直接使用主题原生变量，确保黑夜模式自动变黑 */
        background: var(--entry) !important; 
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      /* 2. 列表区域：严格限制两行高度 & 允许内部滚动 */
      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-height: 82px; 
        overflow-y: auto;
        padding-bottom: 4px;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        align-items: center;
        scrollbar-width: thin;
      }
      
      /* 3. 滚动条：适配黑白模式 */
      .tag-list::-webkit-scrollbar { width: 4px; }
      .tag-list::-webkit-scrollbar-thumb { 
        background: rgba(128,128,128,0.2); 
        border-radius: 10px; 
      }
      
      .tag-list.expanded { 
        max-height: 1200px; 
        overflow-y: visible; 
      }
      
      /* 4. 标签项：确保在深色背景下有层次感 */
      .tag-item {
        display: inline-flex;
        align-items: center;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        line-height: 1.2;
        background: var(--tertiary); /* 比卡片背景稍微亮/深一点的颜色 */
        color: var(--primary);
        border: 1px solid transparent;
        transition: all 0.2s ease;
        text-decoration: none;
      }

      /* 5. 苹果蓝选中态：黑白模式微调 */
      .tag-item.active {
        background: #007aff !important; /* 基础苹果蓝 */
        color: #fff !important;
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.25);
        border: none;
      }
      .dark .tag-item.active {
        background: #0a84ff !important; /* 黑夜模式下稍亮的蓝色 */
      }

      .tag-item:hover:not(.active) { 
        background: var(--secondary); 
        transform: translateY(-1px); 
      }
      
      .expand-btn {
        margin-top: 8px;
        font-size: 12px;
        color: var(--secondary);
        cursor: pointer;
        text-align: center;
        width: 100%;
        opacity: 0.6;
        padding: 4px 0;
      }
    </style>

    <div class="tag-container" id="tagContainer">
      <div class="tag-list" id="tagList">
        {{- $is_all_active := and (eq .Section "posts") (eq .Kind "section") }}
        <a href="{{ "/posts" | relLangURL }}" class="tag-item {{ if $is_all_active }}active{{ end }}">全部</a>
        {{- range $tags.ByCount }}
          {{- $is_this_tag := false }}
          {{- if $.Data.Term }}
            {{- if eq (urlize $.Data.Term) (urlize .Name) }}{{ $is_this_tag = true }}{{ end }}
          {{- end }}
          <a href="{{ "/tags/" | relLangURL }}{{ .Name | urlize }}" class="tag-item {{ if $is_this_tag }}active{{ end }}">
             {{ .Name }} <span style="font-size: 11px; opacity: 0.6; margin-left: 4px;">{{ .Count }}</span>
          </a>
        {{- end }}
      </div>
      <div class="expand-btn" id="expandBtn" onclick="toggleTags()">展开全部 ↓</div>
    </div>

    <script>
      function toggleTags() {
        const list = document.getElementById('tagList');
        const btn = document.getElementById('expandBtn');
        const isExpanded = list.classList.toggle('expanded');
        btn.innerText = isExpanded ? '收起列表 ↑' : '展开全部 ↓';
        list.style.overflowY = isExpanded ? 'visible' : 'auto';
      }
      // 页面加载后的逻辑
      window.onload = function() {
        const list = document.getElementById('tagList');
        const btn = document.getElementById('expandBtn');
        const activeItem = list.querySelector('.active');
        // 如果内容不多，隐藏按钮
        if (list.scrollHeight <= 88) {
          btn.style.display = 'none';
        } else if (activeItem && activeItem.offsetTop > 40) {
          // 如果选中了后面的标签，自动滚动到可见区域
          list.scrollTo({ top: activeItem.offsetTop - 10, behavior: 'smooth' });
        }
      };
    </script>
    {{- end }}
  {{- end }}

  {{/* --- 文章列表逻辑 (保持不变) --- */}}
  {{- $pages := union .RegularPages .Sections }}
  {{- if .IsHome }}
    {{- $pages = where site.RegularPages "Type" "in" site.Params.mainSections }}
    {{- $pages = where $pages "Params.hiddenInHomeList" "!=" "true"  }}
  {{- end }}
  {{- $paginator := .Paginate $pages }}

  {{- range $index, $page := $paginator.Pages }}
  <article class="post-entry">
    <header class="entry-header">
      <h2 class="entry-hint-parent">{{- .Title }}</h2>
    </header>
    <div class="entry-content">
      <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
    </div>
    <footer class="entry-footer">{{- partial "post_meta.html" . -}}</footer>
    <a class="entry-link" href="{{ .Permalink }}"></a>
  </article>
  {{- end }}

  {{- if gt $paginator.TotalPages 1 }}
  <footer class="page-footer">
    <nav class="pagination">
      {{- if $paginator.HasPrev }}<a class="prev" href="{{ $paginator.Prev.URL | absURL }}">« 上一页</a>{{- end }}
      {{- if $paginator.HasNext }}<a class="next" href="{{ $paginator.Next.URL | absURL }}">下一页 »</a>{{- end }}
    </nav>
  </footer>
  {{- end }}

{{- end }}{{/* 结束 else */}}

{{- end }}{{/* 结束 main */}}
