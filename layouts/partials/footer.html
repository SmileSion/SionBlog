{{- if not (.Param "hideFooter") }}
<footer class="footer">
    <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px;">
        {{- if not site.Params.footer.hideCopyright }}
            {{- if site.Copyright }}
            <span>{{ site.Copyright | markdownify }}</span>
            {{- else }}
            <span>&copy; {{ now.Year }} <a href="{{ "" | absLangURL }}">{{ site.Title }}</a></span>
            {{- end }}
        {{- end }}

        <span id="hitokoto-sep" style="display: none; opacity: 0.5;">|</span>
        <span id="hitokoto-text" style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.7; font-size: 0.85em; cursor: help;" title="点击加载下一句"></span>
    </div>

    {{- with site.Params.footer.text }}
        <div style="margin-top: 5px;">{{ . | markdownify }}</div>
    {{- end }}
</footer>
{{- end }}

{{- if (not site.Params.disableScrollToTop) }}
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>
{{- end }}

{{- partial "extend_footer.html" . }}

<a href="/msg-board/" class="floating-contact-globe" id="contactGlobe">
    <div class="globe-content">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
        </svg>
        <span class="globe-text">留言</span>
    </div>
</a>

<style>
.floating-contact-globe {
    position: fixed;
    bottom: 40px;
    right: 30px;
    z-index: 999;
    text-decoration: none !important;
    background: var(--entry); 
    border: 1px solid var(--border);
    padding: 10px 20px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: background 0.2s ease, border-color 0.2s ease, transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.3s ease;
}

.dark .floating-contact-globe {
    background: var(--tertiary);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

.globe-content {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--primary);
}

.floating-contact-globe svg {
    width: 20px;
    height: 20px;
    stroke: var(--primary);
}

.globe-text {
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.floating-contact-globe:hover { transform: translateY(-5px); background: var(--secondary); }

.floating-contact-globe.scrolling { opacity: 0.3; transform: scale(0.9) translateX(15px); pointer-events: none; }

.top-link { bottom: 100px !important; right: 30px; z-index: 1000; }

@media (max-width: 768px) {
    .floating-contact-globe { bottom: 25px; right: 15px; padding: 0; width: 44px; height: 44px; }
    .globe-text { display: none; }
    .top-link { bottom: 85px !important; right: 15px; }
}
</style>

<script>
    /* 1. 一言功能 */
    (function() {
        const textEl = document.getElementById('hitokoto-text');
        const sepEl = document.getElementById('hitokoto-sep');
        function loadHitokoto() {
            fetch('https://v1.hitokoto.cn').then(res => res.json()).then(data => {
                if (textEl && sepEl) {
                    let info = data.from_who ? ` —— ${data.from_who}` : ` —— 「${data.from}」`;
                    textEl.innerText = `${data.hitokoto}${info}`;
                    sepEl.style.display = 'inline';
                    textEl.style.opacity = '0.7';
                }
            }).catch(()=>{});
        }
        loadHitokoto();
        if (textEl) textEl.addEventListener('click', loadHitokoto);
    })();

    /* 2. 悬浮球滚动交互 */
    (function() {
        const globe = document.getElementById('contactGlobe');
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if(!globe) return;
            globe.classList.add('scrolling');
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => globe.classList.remove('scrolling'), 200);
        });
    })();

    /* 3. 核心修复：主题切换功能 */
    (function() {
        const themeBtn = document.getElementById("theme-toggle");
        if (themeBtn) {
            themeBtn.addEventListener("click", () => {
                // 更加严谨的判断：只要 html 属性是 dark 或者 body 类名是 dark，都视为当前是黑夜模式
                const isDarkNow = document.documentElement.dataset.theme === 'dark' || document.body.classList.contains("dark");
                
                if (isDarkNow) {
                    // 执行切换到白天的逻辑
                    document.body.classList.remove('dark');
                    document.documentElement.dataset.theme = 'light';
                    localStorage.setItem("pref-theme", 'light');
                } else {
                    // 执行切换到黑夜的逻辑
                    document.body.classList.add('dark');
                    document.documentElement.dataset.theme = 'dark';
                    localStorage.setItem("pref-theme", 'dark');
                }
            });
        }
    })();

    /* 4. 原生功能：回到顶部显示 */
    (function() {
        const mybutton = document.getElementById("top-link");
        window.onscroll = function () {
            if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
                mybutton.style.visibility = "visible"; mybutton.style.opacity = "1";
            } else {
                mybutton.style.visibility = "hidden"; mybutton.style.opacity = "0";
            }
        };
    })();

    /* 5. 原生功能：平滑跳转 */
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            const id = this.getAttribute("href").substr(1);
            const target = id === "top" ? document.body : document.querySelector(`[id='${decodeURIComponent(id)}']`);
            if (target) {
                target.scrollIntoView({
                    behavior: window.matchMedia('(prefers-reduced-motion: reduce)').matches ? "auto" : "smooth"
                });
            }
        });
    });

    /* 6. 代码复制 */
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        if (!container.classList.contains("highlight")) return;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';
        copybutton.addEventListener('click', () => {
            navigator.clipboard.writeText(codeblock.textContent).then(() => {
                copybutton.innerText = 'copied!';
                setTimeout(() => copybutton.innerText = 'copy', 2000);
            });
        });
        container.appendChild(copybutton);
    });
</script>