<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<div id="admin-tools" style="display:none; margin: 0 auto 1.5rem; max-width: 600px;">
    <div class="admin-bar">
        <span class="admin-badge">ADMIN MODE</span>
        <button onclick="document.getElementById('add-modal').style.display='flex'" class="admin-add-btn">
            发布活动
        </button>
    </div>
</div>

<div id="game-board-container" class="game-board-grid">
    <div class="loading-container">
        <div class="spinner"></div>
        <p>数据同步中...</p>
    </div>
</div>

<div id="add-modal" class="modal-overlay" style="display:none;" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content">
        <div class="modal-header">
            <h3>发起组队</h3>
            <span class="close-icon" onclick="document.getElementById('add-modal').style.display='none'">×</span>
        </div>
        
        <div class="form-body">
            <div class="form-item">
                <label>活动主题</label>
                <input type="text" id="new-title" placeholder="输入名称">
            </div>
            <div class="form-item">
                <label>集合时间</label>
                <input type="text" id="new-time" placeholder="20:00 (次日归档)">
            </div>
            <div class="form-item">
                <label>所需人数</label>
                <input type="number" id="new-limit" value="5">
            </div>
        </div>

        <div class="modal-footer">
            <button onclick="createNewGame()" class="save-btn">发布</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://ralloggoqnsfacbayybh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhbGxvZ2dvcW5zZmFjYmF5eWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDMzODEsImV4cCI6MjA4MzQxOTM4MX0.YJGo-ujknVZOBhclaxR0q4U4hX1CMk9NlNU2P4hndfs';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === 'true';
    if (isAdmin) document.getElementById('admin-tools').style.display = 'block';

    function setDailyCookie(gameId) {
        const d = new Date();
        const midnight = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59);
        document.cookie = `joined_${gameId}=true;expires=${midnight.toUTCString()};path=/`;
    }

    function hasJoinedCookie(gameId) {
        return document.cookie.includes(`joined_${gameId}=true`);
    }

    function checkExpiry(game) {
        const hasClockTime = /\d{1,2}:\d{2}/.test(game.start_time || "");
        if (!hasClockTime) return false;
        return new Date(game.created_at).toDateString() !== new Date().toDateString();
    }

    async function renderBoard() {
        const { data, error } = await _supabase.from('games').select('*').order('id', { ascending: false });
        if (error) return;

        const container = document.getElementById('game-board-container');
        
        const sortedData = data.sort((a, b) => {
            const aExpired = checkExpiry(a);
            const bExpired = checkExpiry(b);
            const aActive = a.is_active && !aExpired;
            const bActive = b.is_active && !bExpired;
            if (aActive === bActive) return b.id - a.id;
            return aActive ? -1 : 1;
        });

        const displayData = sortedData.filter(game => isAdmin ? true : (game.is_active && !checkExpiry(game)));

        if (displayData.length === 0) {
            container.innerHTML = `<div class="empty-state"><p>暂无活动</p></div>`;
            return;
        }

        container.innerHTML = displayData.map(game => {
            const players = game.players ? game.players.split(',').filter(p => p.trim()) : [];
            const isFull = players.length >= game.max_players;
            const alreadyJoined = hasJoinedCookie(game.id);
            const expired = checkExpiry(game);
            const active = game.is_active && !expired;
            
            let cardClass = "game-card";
            if (!active) cardClass += " card-inactive";
            else if (isFull) cardClass += " card-full";

            return `
            <div class="${cardClass}">
                <div class="card-top">
                    <h4 class="game-title">${game.title}</h4>
                    <span class="time-badge">${game.start_time}</span>
                </div>
                
                <div class="player-grid">
                    ${players.map((p, idx) => `
                        <div class="player-chip">
                            <span class="avatar-circle">${p[0].toUpperCase()}</span>
                            <span class="name-text">${p}</span>
                            ${isAdmin ? `<span class="remove-btn" onclick="removePlayer(${game.id}, ${idx}, '${game.players}')">×</span>` : ''}
                        </div>
                    `).join('')}
                    ${players.length < game.max_players && active ? 
                        Array(game.max_players - players.length).fill('<div class="player-placeholder"></div>').join('') : ''}
                </div>

                <div class="card-action">
                    ${active ? `
                        ${(!alreadyJoined || isAdmin) ? `
                            <div class="join-input-group">
                                <input type="text" id="name-${game.id}" maxlength="10" placeholder="昵称" ${isFull ? 'disabled' : ''}>
                                <button onclick="handleSignup(${game.id}, '${game.players || ''}')" ${isFull ? 'disabled' : ''}>
                                    报名
                                </button>
                            </div>
                        ` : `
                            <div class="status-box success">已报名</div>
                        `}
                    ` : `
                        <div class="status-box stopped">招募结束</div>
                    `}
                    
                    ${isAdmin ? `
                        <div class="admin-controls">
                            <span class="text-btn" onclick="toggleGame(${game.id}, ${game.is_active})">${game.is_active ? '停止' : '开启'}</span>
                            <span class="divider">/</span>
                            <span class="text-btn danger" onclick="deleteGame(${game.id})">删除</span>
                        </div>
                    ` : ''}
                </div>
                <div class="progress-line" style="width: ${(players.length / game.max_players) * 100}%"></div>
            </div>`;
        }).join('');
    }

    async function handleSignup(id, current) {
        if (isSubmitting) return;
        const input = document.getElementById(`name-${id}`);
        const name = input.value.trim().replace(/,/g, '');
        if (!name) return;
        if (current.split(',').includes(name)) return alert("重复报名");

        isSubmitting = true;
        const updated = current ? `${current},${name}` : name;
        const { error } = await _supabase.from('games').update({ players: updated }).eq('id', id);
        if (!error) { setDailyCookie(id); renderBoard(); }
        isSubmitting = false;
    }

    async function createNewGame() {
        const title = document.getElementById('new-title').value;
        const time = document.getElementById('new-time').value;
        const limit = document.getElementById('new-limit').value;
        if(!title || !limit) return;
        await _supabase.from('games').insert([{ title, start_time: time, max_players: limit, is_active: true }]);
        document.getElementById('add-modal').style.display = 'none';
        renderBoard();
    }
    async function removePlayer(gameId, idx, currentStr) {
        let arr = currentStr.split(','); arr.splice(idx, 1);
        await _supabase.from('games').update({ players: arr.join(',') }).eq('id', gameId);
        renderBoard();
    }
    async function toggleGame(id, status) {
        await _supabase.from('games').update({ is_active: !status }).eq('id', id);
        renderBoard();
    }
    async function deleteGame(id) {
        if(confirm("删除？")) { await _supabase.from('games').delete().eq('id', id); renderBoard(); }
    }

    let isSubmitting = false;
    renderBoard();
    setInterval(renderBoard, 30000);
</script>

<style>
    /* 样式微调：字号缩小，间距优化 */
    .game-board-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.2rem;
        margin: 1.5rem 0;
        font-size: 14px; /* 整体字号稍微调小 */
    }

    /* --- Loading --- */
    .loading-container { grid-column: 1/-1; text-align: center; padding: 2rem; opacity: 0.5; font-size: 13px; }
    .spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { grid-column: 1/-1; text-align: center; padding: 3rem; opacity: 0.4; border-radius: 10px; border: 1px dashed var(--border); }

    /* --- 卡片 --- */
    .game-card {
        background: var(--entry);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 1.2rem;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: 0.2s;
    }
    .game-card:hover { border-color: var(--primary); opacity: 0.95; }
    .card-inactive { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
    .card-inactive .admin-controls { pointer-events: auto; }

    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .game-title { margin: 0; font-size: 15px; font-weight: 600; color: var(--primary); line-height: 1.4; }
    .time-badge { font-size: 11px; background: var(--tertiary); padding: 2px 6px; border-radius: 4px; opacity: 0.7; }

    /* 玩家列表：核心提取首字母逻辑 */
    .player-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 1.2rem; }
    .player-chip { 
        background: var(--tertiary); padding: 3px 8px 3px 3px; border-radius: 15px; 
        display: flex; align-items: center; font-size: 12px; border: 1px solid rgba(0,0,0,0.03);
    }
    .avatar-circle { 
        width: 18px; height: 18px; background: var(--primary); color: var(--theme); 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        font-size: 10px; font-weight: bold; margin-right: 5px; opacity: 0.9;
    }
    .player-placeholder { width: 18px; height: 18px; border-radius: 50%; border: 1px dashed var(--border); opacity: 0.4; }
    .remove-btn { margin-left: 4px; cursor: pointer; color: #ff5252; opacity: 0.5; font-size: 14px; }

    /* 操作区 */
    .card-action { margin-top: auto; }
    .join-input-group { display: flex; height: 32px; }
    .join-input-group input { 
        flex: 1; background: var(--code-bg); border: 1px solid var(--border); border-right: none;
        border-radius: 6px 0 0 6px; padding: 0 10px; font-size: 13px; color: var(--text); outline: none;
    }
    .join-input-group button {
        background: var(--primary); color: var(--theme); border: none;
        border-radius: 0 6px 6px 0; padding: 0 12px; cursor: pointer; font-size: 12px; font-weight: bold;
    }
    .status-box { text-align: center; padding: 6px; border-radius: 6px; font-size: 12px; background: var(--tertiary); }
    .status-box.success { color: #4caf50; background: rgba(76, 175, 80, 0.05); }

    .progress-line { height: 2px; background: var(--primary); position: absolute; bottom: 0; left: 0; opacity: 0.2; }

    /* 管理员控制 */
    .admin-bar { 
        background: var(--entry); border: 1px solid var(--border); padding: 8px 15px; 
        border-radius: 8px; display: flex; justify-content: space-between; align-items: center; 
    }
    .admin-badge { font-size: 11px; letter-spacing: 1px; opacity: 0.5; font-weight: bold; }
    .admin-add-btn { background: var(--primary); color: var(--theme); border: none; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .admin-controls { margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); text-align: center; font-size: 11px; opacity: 0.6; }
    .text-btn { cursor: pointer; margin: 0 4px; }
    .text-btn:hover { text-decoration: underline; }
    .divider { margin: 0 2px; opacity: 0.3; }

    /* 弹窗 */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); z-index: 999; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--entry); width: 300px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    .modal-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; font-size: 14px; }
    .form-body { padding: 1rem; }
    .form-item { margin-bottom: 0.8rem; }
    .form-item label { display: block; font-size: 12px; margin-bottom: 4px; opacity: 0.6; }
    .form-item input { width: 100%; padding: 7px; border-radius: 4px; border: 1px solid var(--border); background: var(--tertiary); color: var(--text); font-size: 13px; box-sizing: border-box; }
    .modal-footer { padding: 0.8rem; text-align: center; }
    .save-btn { background: var(--primary); color: var(--theme); border: none; padding: 8px; border-radius: 6px; font-weight: bold; width: 100%; cursor: pointer; font-size: 13px; }
</style>