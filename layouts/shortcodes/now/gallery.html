<link rel="stylesheet" href="https://esm.sh/photoswipe@5.4.3/dist/photoswipe.css">

<div class="gallery-wrapper">
    <div class="gallery-nav" id="gallery-filter">
        <button class="filter-btn active" data-filter="all">全部</button>
        <button class="filter-btn" data-filter="photography">摄影</button>
        <button class="filter-btn" data-filter="game">游戏</button>
        <button class="filter-btn" data-filter="daily">日常</button>
    </div>

    <div class="photo-grid" id="gallery">
        {{ $subdirs := slice "photography" "game" "daily" }}
        {{ range $subdirs }}
            {{ $category := . }}
            {{ $path := printf "img/%s/*" $category }}
            {{ $images := $.Page.Resources.Match $path }}
            {{ range $images }}
                {{ $thumbnail := .Resize "800x q80" }}
                <div class="grid-item" data-category="{{ $category }}">
                    <a href="{{ .RelPermalink }}" 
                       data-pswp-width="{{ .Width }}" 
                       data-pswp-height="{{ .Height }}" 
                       class="pswp-link">
                        <img data-src="{{ $thumbnail.RelPermalink }}" alt="Photo" class="lazy-img" />
                        
                        <div class="exif-data" style="display:none;">
                            {{- if .Exif -}}{{- with .Exif.Tags -}}
                                <span class="exif-model">{{ .Model }}</span>
                                <span class="exif-details">{{ if .ExposureTime }}{{ .ExposureTime }}s{{ end }}{{ if .FNumber }} · f/{{ .FNumber }}{{ end }}{{ if .ISOSpeedRatings }} · ISO {{ .ISOSpeedRatings }}{{ end }}</span>
                            {{- end -}}{{- else -}}
                                <span class="exif-model">Smilesion Photography</span>
                            {{- end -}}
                        </div>
                    </a>
                </div>
            {{ end }}
        {{ end }}
    </div>

    <div class="gallery-footer">
        <button id="load-more-btn" class="more-btn">展开更多作品</button>
    </div>
</div>

<style>
/* --- 基础布局 --- */
.gallery-wrapper { margin-top: 2rem; }
.gallery-nav { display: flex; gap: 12px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 10px; }
.filter-btn { background: var(--code-bg); border: none; color: var(--secondary); font-size: 0.85rem; cursor: pointer; padding: 6px 16px; border-radius: 20px; transition: 0.3s; white-space: nowrap; }
.filter-btn.active { background: var(--primary); color: var(--theme); }

.photo-grid { column-count: 3; column-gap: 15px; width: 100%; }
.grid-item { break-inside: avoid; margin-bottom: 15px; display: none; animation: pswpFadeIn 0.5s ease forwards; }
@keyframes pswpFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.grid-item img { width: 100%; height: auto; border-radius: 12px; cursor: zoom-in; display: block; background: var(--code-bg); transition: 0.3s; min-height: 100px; object-fit: cover; }
.more-btn { background: var(--entry); border: 1px solid var(--border); color: var(--primary); padding: 10px 32px; border-radius: 25px; cursor: pointer; margin-top: 20px; }

/* 懒加载占位 */
.lazy-img { opacity: 0; transition: opacity 0.5s; }
.lazy-img[src] { opacity: 1; }

/* --- PhotoSwipe EXIF 浮层样式 (修正版) --- */
.pswp__custom-caption {
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    color: #f5f5f5;
    padding: 8px 18px;
    border-radius: 100px;
    font-size: 13px;
    
    /* 核心定位：固定在屏幕底部 */
    position: absolute;
    bottom: 30px; 
    left: 50%;
    transform: translateX(-50%);
    
    white-space: nowrap;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 2000;
    pointer-events: none; /* 防止遮挡点击 */
    
    /* 动画 */
    opacity: 0;
    transition: opacity 0.3s ease;
    max-width: 90%;
    overflow: hidden;
    text-overflow: ellipsis;
}

.exif-model { font-weight: 700; margin-right: 8px; color: #fff; }
.exif-details { opacity: 0.85; font-family: ui-monospace, SFMono-Regular, monospace; letter-spacing: 0.5px; }

/* 移动端适配：列数调整 */
@media (max-width: 768px) {
    .photo-grid { column-count: 2; }
}
@media (max-width: 480px) {
    .photo-grid { column-count: 1; }
    .pswp__custom-caption { bottom: 20px; font-size: 12px; padding: 6px 14px; }
}
</style>

<script type="module">
import PhotoSwipeLightbox from 'https://esm.sh/photoswipe@5.4.3/lightbox';
import PhotoSwipe from 'https://esm.sh/photoswipe@5.4.3';

document.addEventListener('DOMContentLoaded', () => {
    // 1. 懒加载与分类逻辑
    const gridItems = document.querySelectorAll('.grid-item');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const loadMoreBtn = document.getElementById('load-more-btn');
    let currentFilter = 'all', perPage = 6, visibleCount = perPage;

    const lazyLoadVisible = () => {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) { 
                        img.src = img.dataset.src; 
                        img.removeAttribute('data-src'); 
                    }
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '200px' });
        document.querySelectorAll('.grid-item[style*="display: block"] img').forEach(img => observer.observe(img));
    };

    const applyFilter = () => {
        let count = 0;
        let total = 0;
        
        gridItems.forEach(item => {
            const isMatch = currentFilter === 'all' || item.dataset.category === currentFilter;
            
            if (isMatch) {
                total++;
                if (count < visibleCount) {
                    item.style.display = 'block';
                    count++;
                } else {
                    item.style.display = 'none';
                }
            } else {
                item.style.display = 'none';
            }
        });
        
        loadMoreBtn.style.display = visibleCount >= total ? 'none' : 'block';
        lazyLoadVisible();
    };

    filterBtns.forEach(btn => btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter; 
        visibleCount = perPage; // 切换分类重置数量
        applyFilter();
    }));

    if(loadMoreBtn) {
        loadMoreBtn.addEventListener('click', () => { 
            visibleCount += perPage; 
            applyFilter(); 
        });
    }
    
    // 初始化筛选
    applyFilter();


    // 2. PhotoSwipe 初始化与 EXIF 注入
    const lightbox = new PhotoSwipeLightbox({
        gallery: '#gallery',
        children: 'a.pswp-link',
        pswpModule: PhotoSwipe,
        // 给底部留空，防止 UI 遮挡图片主体
        padding: { top: 20, bottom: 60, left: 20, right: 20 } 
    });

    // 【关键步骤1】解析 HTML 数据：初始化时就把 EXIF 抓取并存入 itemData
    lightbox.addFilter('domItemData', (itemData, element, link) => {
        if (link) {
            const exifDiv = link.querySelector('.exif-data');
            // 将 HTML 字符串存入数据对象
            itemData.exifHtml = exifDiv ? exifDiv.innerHTML : '';
        }
        return itemData;
    });

    // 【关键步骤2】注册全局 UI 元素
    lightbox.on('uiRegister', () => {
        lightbox.pswp.ui.registerElement({
            name: 'custom-caption',
            order: 9,
            isAttachedToElement: false, // 全局模式，不随图片缩放
            appendTo: 'wrapper',        // 挂载到根容器
            tagName: 'div',
            className: 'pswp__custom-caption',
            onInit: (el, pswp) => {
                el.style.display = 'none'; // 默认隐藏

                // 监听切换事件
                pswp.on('change', () => {
                    const currSlide = pswp.currSlide;
                    if (currSlide && currSlide.data && currSlide.data.exifHtml) {
                        // 更新内容
                        el.innerHTML = currSlide.data.exifHtml;
                        el.style.display = 'block';
                        
                        // 简单的淡入效果
                        el.style.opacity = '0';
                        setTimeout(() => { el.style.opacity = '1'; }, 50);
                    } else {
                        // 如果没有 EXIF 数据，可以隐藏或者显示默认文字
                        el.style.opacity = '0';
                        setTimeout(() => { el.style.display = 'none'; }, 200);
                    }
                });
            }
        });
    });

    lightbox.init();
});
</script>